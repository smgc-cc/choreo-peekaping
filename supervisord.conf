[supervisord]
nodaemon=true
logfile=/tmp/supervisor/supervisord.log
pidfile=/tmp/supervisor/supervisord.pid
childlogdir=/tmp/supervisor

[program:redis]
command=redis-server --bind 127.0.0.1 --port 6379 --dir /tmp/redis --protected-mode no --appendonly no
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=90
startsecs=3

[program:api]
command=/app/server/api
directory=/app/server
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=100
startsecs=10

[program:producer]
command=/app/server/producer
directory=/app/server
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=110
startsecs=10

[program:worker]
command=/app/server/worker
directory=/app/server
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=120
startsecs=10

[program:ingester]
command=/app/server/ingester
directory=/app/server
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=130
startsecs=10

[program:caddy]
command=caddy run --config /etc/caddy/Caddyfile
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=XDG_DATA_HOME="/tmp/caddy",XDG_CONFIG_HOME="/tmp/caddy"
priority=200
startsecs=5

[program:komari-agent]
# 使用 sh -c 来执行逻辑判断：
# 1. 如果变量存在：exec 启动 agent（exec 确保 agent 替换 shell 进程，接收信号）
# 2. 如果变量不存在：echo 提示并以 exit 0 退出
command=/bin/sh -c "if [ -n \"$KOMARI_SERVER\" ] && [ -n \"$KOMARI_SECRET\" ]; then echo 'Starting Komari Agent...'; exec /app/komari-agent -e \"$KOMARI_SERVER\" -t \"$KOMARI_SECRET\" --disable-auto-update; else echo 'Komari vars not set, skipping agent.'; exit 0; fi"
directory=/app
autostart=true
# 关键设置：unexpected
# 如果程序以 0 退出（即未配置变量跳过的情况），Supervisor 不会重启它。
# 如果程序崩溃（非 0 退出），Supervisor 会重启它。
autorestart=unexpected
exitcodes=0
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=150
# startsecs=0 允许程序快速退出（跳过时）而不被标记为启动失败
startsecs=0
